name: Monorepo CI

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  API_PORT: '4000'
  MONGO_URI: 'mongodb://localhost:27017/qyou'
  JWT_ACCESS_SECRET: '12345678901234567890123456789012'
  JWT_REFRESH_SECRET: 'abcdefghijklmnopqrstuvwxyz123456'
  STELLAR_NETWORK: 'TESTNET'
  STELLAR_SECRET_KEY: 'SAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'
  NEXT_PUBLIC_API_URL: 'https://api.example.com'
  ADMIN_JWT_SECRET: 'abcdefghijklmnopqrstuvwxyz123456'
  EXPO_PUBLIC_API_URL: 'https://api.example.com'

jobs:
  changes:
    name: Detect Changed Workspaces
    runs-on: ubuntu-latest
    outputs:
      shared: ${{ steps.filter.outputs.shared }}
      api: ${{ steps.filter.outputs.api }}
      admin_web: ${{ steps.filter.outputs.admin_web }}
      mobile: ${{ steps.filter.outputs.mobile }}
      stellar: ${{ steps.filter.outputs.stellar }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            shared:
              - 'package.json'
              - 'package-lock.json'
              - 'tsconfig.json'
              - 'libs/**'
              - '.github/workflows/**'
            api:
              - 'apps/api/**'
            admin_web:
              - 'apps/admin-web/**'
            mobile:
              - 'apps/mobile/**'
            stellar:
              - 'stellar/**'

  api:
    name: API Checks
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.shared == 'true' || needs.changes.outputs.api == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint --workspace=apps/api --if-present

      - name: Unit tests
        run: npm run test --workspace=apps/api --if-present

      - name: Type check
        run: npx tsc --noEmit -p apps/api/tsconfig.json

      - name: Build
        run: npm run build --workspace=apps/api --if-present

  admin_web:
    name: Admin Web Checks
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.shared == 'true' || needs.changes.outputs.admin_web == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint --workspace=apps/admin-web --if-present

      - name: Unit tests
        run: npm run test --workspace=apps/admin-web --if-present

      - name: Type check
        run: npx tsc --noEmit -p apps/admin-web/tsconfig.json

      - name: Build
        run: npm run build --workspace=apps/admin-web --if-present

  mobile:
    name: Mobile Checks
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.shared == 'true' || needs.changes.outputs.mobile == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint --workspace=apps/mobile --if-present

      - name: Unit tests
        run: npm run test --workspace=apps/mobile --if-present

      - name: Type check
        run: npx tsc --noEmit -p apps/mobile/tsconfig.json

      - name: Build
        run: npm run build --workspace=apps/mobile --if-present

  stellar:
    name: Stellar Client Checks
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.shared == 'true' || needs.changes.outputs.stellar == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Unit tests
        run: npm run test --workspace=stellar/client --if-present

      - name: Type check
        run: npx tsc --noEmit -p stellar/client/tsconfig.json

      - name: Build
        run: npm run build --workspace=stellar/client --if-present

  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [changes, api, admin_web, mobile, stellar]
    if: always()
    steps:
      - name: Ensure affected checks passed
        run: |
          echo "API job: ${{ needs.api.result }}"
          echo "Admin Web job: ${{ needs.admin_web.result }}"
          echo "Mobile job: ${{ needs.mobile.result }}"
          echo "Stellar job: ${{ needs.stellar.result }}"

          if [[ "${{ needs.api.result }}" == "failure" || "${{ needs.api.result }}" == "cancelled" ]]; then
            exit 1
          fi

          if [[ "${{ needs.admin_web.result }}" == "failure" || "${{ needs.admin_web.result }}" == "cancelled" ]]; then
            exit 1
          fi

          if [[ "${{ needs.mobile.result }}" == "failure" || "${{ needs.mobile.result }}" == "cancelled" ]]; then
            exit 1
          fi

          if [[ "${{ needs.stellar.result }}" == "failure" || "${{ needs.stellar.result }}" == "cancelled" ]]; then
            exit 1
          fi

          echo "All required affected-workspace checks passed."
